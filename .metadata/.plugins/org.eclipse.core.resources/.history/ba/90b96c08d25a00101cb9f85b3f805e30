package com.sysu.sharemovie.action.movielist;

import java.util.Iterator;

import com.google.appengine.api.datastore.Key;
import com.google.appengine.api.datastore.KeyFactory;
import com.opensymphony.xwork2.ModelDriven;
import com.sysu.sharemovie.action.BaseAction;
import com.sysu.sharemovie.action.comment.deleteComment;
import com.sysu.sharemovie.action.movie.deleteMovie;
import com.sysu.sharemovie.dao.MovieDAO;
import com.sysu.sharemovie.dao.MovieListDAO;
import com.sysu.sharemovie.dao.SMUserDAO;
import com.sysu.sharemovie.jdo.Movie;
import com.sysu.sharemovie.jdo.MovieList;
import com.sysu.sharemovie.jdo.SMUser;

@SuppressWarnings("serial")
public class deleteMovieList extends BaseAction {
	private Long listID;
	
	public void setListID(Long listID) {
		this.listID = listID;
	}

	public Long getListID() {
		return listID;
	}

	public String execute() {
		if (!loggedIn())
			return LOGIN;
		Key listkey=KeyFactory.createKey(MovieList.class.getSimpleName(), movieID);
		MovieDAO movieDAO = new MovieDAO();
		movieDAO.makeconnect();
		Movie movie = movieDAO.queryMovieInMovieList(moviekey);
		movieDAO.closeconnect();
		if (list.getAuthor().compareTo((Key) getSession("userkey"))!=0)
			return ERROR;
		delMovieList(list.getKey());
		return SUCCESS;
	}
	
	public boolean delMovieList(Key key)
	{
		SMUserDAO userDAO = new SMUserDAO();
		MovieListDAO listDAO = new MovieListDAO();
		userDAO.makeconnect();
		listDAO.makeconnect();
		MovieList list = listDAO.queryMovieListByID(key);
		SMUser author = userDAO.querySMUserByID(list.getAuthor());
		author.getUserMovielist().remove(list.getKey());
		Iterator<Key> i;
		i = list.getMovieInList().iterator();
		deleteMovie delMov = new deleteMovie();
		for (;i.hasNext();) {
			delMov.delMovie(i.next());
		}
		i = list.getMovieComment().iterator();
		deleteComment delCom = new deleteComment();
		for (;i.hasNext();) {
			delCom.delComment(i.next());
		}
		listDAO.deleteMovieList(key);
		userDAO.closeconnect();
		listDAO.closeconnect();
		return true;
	}

}
